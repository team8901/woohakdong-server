name: Build and Push to OCIR

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      REGISTRY: yny.ocir.io
      REPO: woohakdong

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('**/build.gradle', '**/settings.gradle') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Docker login to OCIR
        run: |
          echo "${{ secrets.OCIR_AUTH_TOKEN }}" | docker login ${{ env.REGISTRY }} \
            -u "${{ secrets.OCIR_TENANT_NS }}/${{ secrets.OCIR_EMAIL }}" \
            --password-stdin

      - name: Build & Push
        id: build
        run: |
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          IMAGE="${{ env.REGISTRY }}/${{ secrets.OCIR_TENANT_NS }}/${{ env.REPO }}:${SHORT_SHA}"

          echo "Building $IMAGE for ARM64"
          docker buildx build \
            --platform linux/arm64 \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -t "$IMAGE" \
            --push \
            .

          echo "image_tag=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          if [ -d /tmp/.buildx-cache-new ]; then
            mv /tmp/.buildx-cache-new /tmp/.buildx-cache
          fi

      - name: Update infra repository
        env:
          INFRA_REPO_TOKEN: ${{ secrets.INFRA_REPO_TOKEN }}
          IMAGE_TAG: ${{ steps.build.outputs.image_tag }}
          REGISTRY: ${{ env.REGISTRY }}
          TENANT_NS: ${{ secrets.OCIR_TENANT_NS }}
          REPO: ${{ env.REPO }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Infra 저장소 클론
          git clone https://x-access-token:${INFRA_REPO_TOKEN}@github.com/team8901/woohakdong-infra.git
          cd woohakdong-infra

          # deployment.yaml의 이미지 태그 업데이트
          sed -i "s|image: ${REGISTRY}/${TENANT_NS}/${REPO}:.*|image: ${REGISTRY}/${TENANT_NS}/${REPO}:${IMAGE_TAG}|g" k8s/web/deployment.yaml

          # 변경사항 확인
          echo "Updated deployment.yaml:"
          git diff k8s/web/deployment.yaml

          # 변경사항이 있으면 커밋 및 푸시
          if git diff --quiet k8s/web/deployment.yaml; then
            echo "No changes to commit"
          else
            git add k8s/web/deployment.yaml
            git commit -m "Update image tag to ${IMAGE_TAG}"
            git push
            echo "Successfully pushed changes to infra repository"
          fi
